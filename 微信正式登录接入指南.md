# 微信正式登录接入指南

要让用户**真正用微信账号登录**并**在「我的作品」里保存、查看自己的数据**，需要完成下面几步。

---

## 一、前提说明

- **本地 localhost 不能做正式微信登录**：微信开放平台要求授权回调地址必须是 **HTTPS + 已备案域名**，不支持 `http://localhost`。
- **两种使用方式**：
  - **本地开发 / 试玩**：不配置微信，用当前「模拟登录」即可（点微信登录会直接生成试玩用户，数据在内存里，重启清空）。
  - **正式上线**：把网站部署到有域名的服务器（HTTPS），在微信开放平台创建「网站应用」并配置好后，用户即可用微信扫码/跳转登录，数据按用户保存。

下面步骤针对「正式上线、真实微信登录」。

---

## 二、在微信开放平台创建「网站应用」

1. **注册/登录**
   - 打开 [微信开放平台](https://open.weixin.qq.com/)
   - 使用企业主体注册（个人无法创建网站应用），完成开发者认证。

2. **创建网站应用**
   - 进入「管理中心」→「网站应用」→「创建网站应用」。
   - 填写应用名称、简介、官网等，提交审核（审核通常需数天）。

3. **获取 AppID、AppSecret**
   - 应用审核通过后，在应用详情里可以看到 **AppID**（形如 `wxXXXXXXXXXXXXXXXX`）和 **AppSecret**（需点击生成/查看，务必保密）。

4. **配置授权回调域**
   - 在同一应用详情里找到「开发信息」→「授权回调域」。
   - 填写你的**网站域名**，例如：`yourdomain.com`（不要写 `https://`、不要写路径、不要写端口）。
   - 微信只会把用户重定向到该域名下的地址，所以你的站点必须部署在这个域名下并开启 HTTPS。

---

## 三、部署网站（HTTPS + 域名）

1. 将本项目（前端 + `server` 目录）部署到一台有域名的服务器，并配置 **HTTPS**（可用 Nginx + Let’s Encrypt 等）。
2. 确保用户访问的地址是：`https://你的域名.com`（与你在开放平台填的「授权回调域」一致）。
3. 在服务器上运行本项目的 Node 服务（见下一节），并保证外网能访问到该服务（例如 Nginx 反向代理到 `http://127.0.0.1:3000`）。

---

## 四、在服务器上配置微信参数

有两种方式任选其一。

### 方式 A：使用 .env 文件（推荐）

1. 在 `server` 目录下复制示例配置：
   ```text
   cp .env.example .env
   ```
   （Windows 下可直接复制 `env.example` 并重命名为 `.env`。）

2. 编辑 `server/.env`，填入真实值：
   ```env
   WECHAT_APP_ID=wx你的AppID
   WECHAT_APP_SECRET=你的AppSecret
   BASE_URL=https://你的域名.com
   ```
   - `BASE_URL` 必须与用户浏览器里访问的地址一致（HTTPS + 域名），且域名已在开放平台配置为授权回调域。

3. 重启 Node 服务，使配置生效。

### 方式 B：使用环境变量

在启动前设置环境变量（示例为 Linux/macOS，Windows 可在「系统属性 → 环境变量」或批处理里用 `set` 设置）：

```bash
export WECHAT_APP_ID=wx你的AppID
export WECHAT_APP_SECRET=你的AppSecret
export BASE_URL=https://你的域名.com
cd server
npm install
node server.js
```

---

## 五、验证是否生效

1. 用浏览器打开：`https://你的域名.com`（不要用 localhost）。
2. 点击「微信登录」：
   - 若配置正确，会跳转到微信开放平台的授权页，用户扫码或确认后跳回你的站点并完成登录。
3. 登录后做一次「选泥 → … → 烧制」并点「收藏」：
   - 再打开「我的作品」，应能看到刚保存的作品，且该数据与该微信用户绑定。

---

## 六、数据持久化（可选）

当前版本用户与作品存在**内存**中，服务重启会清空。若需长期保存：

- 将 `server/server.js` 里的 `users`、`ceramicsByUser`、`sessionToUser` 改为使用数据库（如 SQLite、MySQL）或文件存储，在启动时加载、在接口里读写即可。  
- 用户标识建议继续使用微信返回的 `openid`，这样同一微信用户在不同设备登录看到的都是同一份「我的作品」。

---

## 七、常见问题

| 现象 | 可能原因 | 处理 |
|------|----------|------|
| 点「微信登录」仍跳到模拟登录 / 无跳转 | 未配置 `WECHAT_APP_ID` 或未重启服务 | 检查 `server/.env` 或环境变量，重启 Node |
| 微信提示 redirect_uri 错误 | 回调地址与开放平台配置不一致 | 确保 `BASE_URL` 为 `https://你的域名.com`，且开放平台「授权回调域」为该域名 |
| 扫码后白屏 / 报错 | 未用 HTTPS 或域名未备案/未在开放平台配置 | 使用 HTTPS，并在开放平台填写正确回调域 |
| 我的作品为空 / 丢失 | 当前为内存存储，重启即清空 | 见「六、数据持久化」改为数据库 |

按上述步骤配置后，用户即可通过微信正常登录，并在「我的作品」中保存和查看自己的数据。若你希望，我也可以根据你用的数据库类型，帮你写一段 `server.js` 里持久化用户与作品的示例代码。
